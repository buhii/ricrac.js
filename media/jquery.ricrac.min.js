/* jquery.ricrac.js (C) Takahiro Kamatani Licensed under the MIT */(function(e){e.fn.ricrac=function(t){function c(t){u=new e.fn.ricrac.DataManager(o);f=false;l=undefined;var i=o.gridSize;n=i*o.gridColumn+o.borderWidth;r=i*Math.ceil(u.length/o.gridColumn)+o.borderWidth;if(t){n=t.width;r=t.height}a.width(n);a.height(r);s.canvas.width=n;s.canvas.height=r;if(o.resizable){h()}p();d()}function h(){a.resizable({resize:function(e,t){var n=parseInt((t.size.width-o.borderWidth)/o.gridSize);a.changeSettings({initData:a.data(),gridColumn:n,size:t.size});var r=Math.ceil(u.length/n)*o.gridSize+o.borderWidth;a.resizable({minHeight:r,maxHeight:r})},minWidth:o.gridSize+o.borderWidth})}function p(){var e;var t=o.gridSize;var n=Math.ceil(o.borderWidth/2);var r=o.gridColumn;var i=Math.ceil(u.length/r);s.translate(n,n);s.strokeStyle=o.borderColor;s.lineWidth=o.borderWidth;var a;for(e=0;e<=r;e++){if(u.length%r!=0&&Math.floor(u.length/r)==0){if(e>u.length%r){break}}s.beginPath();s.moveTo(t*e,-n);if(u.length%r>=e){a=t*i}else if(u.length%r!=0){a=t*(i-1)}s.lineTo(t*e,a+n);s.stroke()}for(e=0;e<=i;e++){s.beginPath();s.moveTo(-n,t*e);if(Math.floor(u.length/r)==0){a=t*(u.length%r)+n}else if(e==i&&u.length%r!=0){a=t*(u.length%r)+n}else{a=t*r+n}s.lineTo(a,t*e);s.stroke()}s.translate(0,0)}function d(){for(var e=0;e<u.length;e++){v(e+u.minPos)}}function v(e){var t=u.getValue(e);s.fillStyle=t?o.colorOn:o.colorOff;var n=u.getRect(e);s.fillRect(n[0],n[1],n[2],n[3])}function m(e,t){var n=u.getPos(e,t);if(n&&(!l||l!=n)){if(o.changePos){o.changePos(n)}return n}}function g(e,t){var n=m(e,t);if(n&&f&&!o.readonly){l=n;u.invertValue(l);if(o.changeData){o.changeData(u.data)}v(l)}}if(this.length>1){this.each(function(){e(this).ricrac(t)});return this}var n,r;var s=this[0].getContext("2d");var o=e.extend({},e.fn.ricrac.defaults,t);var u;var a=this;var f;var l;this.changeSettings=function(t){o=e.extend({},o,t);c(t.size)};this.data=function(){return u.data};c();e(window).bind("mouseup",function(){f=false;curentPos=undefined});this.mousedown(function(e){if(e.preventDefault){e.preventDefault()}f=true;g(e.offsetX,e.offsetY)});this.mouseup(function(){f=false;l=undefined});this.mousemove(function(e){g(e.offsetX,e.offsetY)});this.bind("touchcancel",function(){f=false;l=undefined});this.bind("touchstart touchmove",function(e){if(e.type=="touchstart"){l=undefined}var t=e.originalEvent;t.preventDefault();f=true;var n=0,r=0;var s=this;if(s.offsetParent!==undefined){do{n+=s.offsetLeft;r+=s.offsetTop}while(s=s.offsetParent)}for(i=0;i<t.touches.length;i++){g(t.touches[i].pageX-n,t.touches[i].pageY-r)}});this.bind("touchup",function(e){f=false;l=undefined});return this};e.fn.ricrac.DataManager=function(e){this.length=e.dataRange[1]-e.dataRange[0]+1;this.data=e.initData||[];for(var t=this.data.length;t<this.length;t++){this.data.push(0)}this.minPos=e.dataRange[0];var n=e.gridSize;var r=e.gridColumn;var i=e.borderWidth;this.getPos=function(e,t){if(e<=i||t<=i||n*r<=e)return undefined;var s=Math.floor((e-i)/n);var o=Math.floor((t-i)/n);var u=o*r+s;if(0<=u&&u<this.length){return this.minPos+u}else{return undefined}};this.getValue=function(e){return this.data[e-this.minPos]};this.getRect=function(e){var t=(e-this.minPos)%r;var s=Math.floor((e-this.minPos)/r);return[t*n+i/2,s*n+i/2,n-i,n-i]}};e.fn.ricrac.DataManager.prototype={invertValue:function(e){e-=this.minPos;this.data[e]=this.data[e]==0?1:0}};e.fn.ricrac.defaults={readonly:false,resizable:false,initData:undefined,dataRange:[1,25],gridColumn:5,gridSize:32,borderColor:"#ccc",borderWidth:0,showNumber:false,colorOn:"#50a0cc",colorOff:"#ffffff",changePos:undefined,changeData:undefined}})(jQuery)
